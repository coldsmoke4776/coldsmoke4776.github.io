---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import { ARCADE_EXPERIENCES } from "@/data/arcade";

const intro =
  "Arcade is where I drop the playable bits—math sims, browser-friendly games, and UI toys that are meant to be touched, not just read about.";
---

<Layout title="Arcade — Matt Twells">
  <Section title="Arcade">
    <div class="max-w-5xl mx-auto space-y-6 text-center">
      <p class="text-lg md:text-xl text-white/70 leading-relaxed">{intro}</p>
      <p class="text-sm text-white/50">
        Everything below either already runs in your browser or is in the queue for a live build. Hit a link, spawn the demo, and let the systems ride.
      </p>
    </div>
    <div class="mx-auto mt-10 grid max-w-6xl gap-6 md:grid-cols-2">
      {
        ARCADE_EXPERIENCES.map((experience) => (
          <article
            id={experience.title === "C&D&D Terminal RPG" ? "cndnd-terminal" : undefined}
            class="flex flex-col gap-4 rounded-2xl border border-white/10 bg-white/5 p-6 shadow-[0_20px_60px_-40px_rgba(0,0,0,0.8)]"
          >
            <div class="flex items-center gap-3">
              <h3 class="text-2xl font-semibold text-[#0f0]">{experience.title}</h3>
            </div>
            <p class="text-base text-white/80 leading-relaxed">{experience.description}</p>
            <div class="flex flex-wrap gap-2">
              {
                experience.tags.map((tag) => (
                  <span class="text-xs font-mono tracking-[0.3em] uppercase text-white/60 bg-white/5 px-3 py-1 rounded-full border border-white/10">
                    {tag}
                  </span>
                ))
              }
            </div>
            <div class="flex flex-wrap gap-2">
              {
                experience.links.map((link) => {
                  const isExternal = !link.href.startsWith("/");
                  return (
                    <a
                      class="text-sm font-semibold uppercase tracking-[0.3em] text-white bg-black/70 border border-white/30 px-4 py-2 rounded-full hover:bg-white hover:text-black transition"
                      href={link.href}
                      target={isExternal ? "_blank" : undefined}
                      rel={isExternal ? "noreferrer" : undefined}
                    >
                      {link.label}
                    </a>
                  );
                })
              }
            </div>
            {
              experience.terminal && (
                <>
                  <div class="mt-4 flex items-center justify-between">
                    <p class="text-xs uppercase tracking-[0.3em] text-white/50">
                      {experience.terminal.caption}
                    </p>
                    <button
                      type="button"
                      class="text-xs font-semibold uppercase tracking-[0.4em] px-3 py-1 rounded-full border border-white/30 bg-black/70 hover:bg-white hover:text-black transition"
                      data-terminal-reset
                    >
                      Reset
                    </button>
                  </div>
                  <div
                    class="arcade-terminal mt-2"
                    data-terminal-config={JSON.stringify(experience.terminal)}
                  >
                  </div>
                </>
              )
            }
          </article>
        ))
      }
    </div>
  </Section>
  <script is:inline type="module">

    if (typeof window !== "undefined") {
      const XTERM_MODULE_URL = "https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js";
      const XTERM_CSS_URL = "https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css";

      const ensureCss = () => {
        if (document.querySelector(`link[href="${XTERM_CSS_URL}"]`)) {
          return;
        }
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = XTERM_CSS_URL;
        document.head.appendChild(link);
      };

      ensureCss();

      let xtermLoader = null;
      const loadXterm = () => {
        if (!xtermLoader) {
          xtermLoader = import(XTERM_MODULE_URL);
        }
        return xtermLoader;
      };

      const containers = document.querySelectorAll("[data-terminal-config]");
      containers.forEach((container) => {
        (async () => {
          const configText = container.getAttribute("data-terminal-config");
          if (!configText) return;
          let config;
          try {
            config = JSON.parse(configText);
          } catch (error) {
            console.error("Unable to parse terminal config", error);
            return;
          }

          const { Terminal } = await loadXterm();
          const term = new Terminal({
            cursorBlink: true,
            fontFamily: "VCR, monospace",
            theme: { background: "#010101", foreground: "#c8ffc8" },
          });
          term.open(container);
          term.focus();

          const queue = [];
          const enqueue = (value) => {
            for (let i = 0; i < value.length; i += 1) {
              queue.push(value.charCodeAt(i));
            }
          };

          term.onKey(({ key, domEvent }) => {
            if (domEvent.key === "Enter") {
              enqueue("\n");
              term.write("\r\n");
              return;
            }
            if (domEvent.key === "Backspace") {
              enqueue("\b");
              term.write("\b \b");
              return;
            }
            enqueue(key);
            term.write(key);
          });

          const moduleConfig = {
            wasmBinaryFile: config.wasmPath,
            locateFile: (_, scriptDirectory) =>
              config.wasmPath.startsWith("http") ? config.wasmPath : new URL(config.wasmPath, scriptDirectory).href,
            print: (text) => term.write(`${text}\r\n`),
            printErr: (text) => term.write(`\x1b[31m${text}\x1b[0m\r\n`),
            stdin: () => (queue.length ? queue.shift() ?? -1 : -1),
            noExitRuntime: true,
            arguments: [],
          };

          let factoryPromise = null;
          const getFactory = () => {
            if (factoryPromise) {
              return factoryPromise;
            }
            factoryPromise = import(config.scriptPath).then((mod) => {
              const maybeFactory =
                (config.factoryName && mod[config.factoryName]) ||
                mod.default ||
                mod.createCndndModule ||
                mod.createModule ||
                mod.Module;
              if (typeof maybeFactory !== "function") {
                throw new Error("Could not resolve a factory function from the C&D&D module");
              }
              return maybeFactory;
            });
            return factoryPromise;
          };

          const runModule = () => {
            getFactory()
              .then((factory) => factory({ ...moduleConfig }))
              .then((instance) => {
                if (instance?.callMain) {
                  instance.callMain([]);
                }
              })
              .catch((error) => {
                term.write(`\x1b[31mFailed to load C&D&D: ${error.message}\x1b[0m\r\n`);
              });
          };

          runModule();

          const resetButton = container.parentElement?.querySelector("[data-terminal-reset]");
          resetButton?.addEventListener("click", () => {
            factoryPromise = null;
            term.reset();
            term.write("\x1b[33mReloading...\x1b[0m\r\n");
            runModule();
          });
        })();
      });
    }
  </script>
</Layout>
